<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Mass Sender</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center flex items-center justify-center">
      <i class='bx bxl-whatsapp text-4xl mr-2'></i> WhatsApp Mass Sender
    </h1>

    <!-- Seção de Token -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class='bx bx-key mr-2'></i> Autenticação
      </h2>
      <input
        id="token"
        type="text"
        placeholder="Insira seu token"
        class="w-full p-2 border rounded-md mb-4"
      >
    </div>

    <!-- Seção de Autenticação WhatsApp -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class='bx bx-qr-scan mr-2'></i> Autenticação WhatsApp
      </h2>
      <div id="qr-section">
        <p id="qr-status" class="text-gray-600">Insira um token válido para carregar o QR code...</p>
        <img id="qr-code" class="hidden mx-auto" alt="QR Code">
      </div>
    </div>

    <!-- Formulário de Números e Mensagem -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class='bx bx-list-ul mr-2'></i> Números e Mensagem
      </h2>
      <textarea
        id="numbers"
        rows="5"
        placeholder="Insira os números (um por linha, ex: 351912345678)"
        class="w-full p-2 border rounded-md mb-4"
      ></textarea>
      <input
        id="message"
        type="text"
        placeholder="Digite a mensagem"
        value="Olá, [saudacao]!"
        class="w-full p-2 border rounded-md mb-4"
      >
      <button
        id="start-btn"
        disabled
        class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center"
      >
        <i class='bx bx-send mr-2'></i> Iniciar Envio
      </button>
    </div>

    <!-- Progresso -->
    <div id="progress-section" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class='bx bx-loader-circle mr-2'></i> Progresso
      </h2>
      <p id="progress-text">Aguardando início...</p>
      <p id="countdown-text" class="hidden"></p>
      <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-2.5">
        <div id="progress-fill" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <!-- Relatório -->
    <div id="report-section" class="bg-white p-6 rounded-lg shadow-md hidden">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class='bx bx-bar-chart-alt-2 mr-2'></i> Relatório Final
      </h2>
      <p id="report-total"></p>
      <p id="report-success"></p>
      <p id="report-failures"></p>
      <p id="report-duration"></p>
    </div>

    <p class="text-sm text-gray-600 text-center">Certifique-se de que os destinatários consentiram em receber mensagens.</p>
  </div>

  <script>
    const tokenInput = document.getElementById('token');
    const qrSection = document.getElementById('qr-section');
    const qrStatus = document.getElementById('qr-status');
    const qrCode = document.getElementById('qr-code');
    const numbersInput = document.getElementById('numbers');
    const messageInput = document.getElementById('message');
    const startBtn = document.getElementById('start-btn');
    const progressSection = document.getElementById('progress-section');
    const progressText = document.getElementById('progress-text');
    const countdownText = document.getElementById('countdown-text');
    const progressFill = document.getElementById('progress-fill');
    const reportSection = document.getElementById('report-section');
    const reportTotal = document.getElementById('report-total');
    const reportSuccess = document.getElementById('report-success');
    const reportFailures = document.getElementById('report-failures');
    const reportDuration = document.getElementById('report-duration');

    // Obter saudação dinâmica
    function getGreeting() {
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 12) return 'Bom dia';
      if (hour >= 12 && hour < 18) return 'Boa tarde';
      return 'Boa noite';
    }

    // Verificar status do WhatsApp
    async function checkStatus() {
      const token = tokenInput.value.trim();
      if (!token) {
        qrStatus.textContent = 'Insira um token válido para carregar o QR code...';
        qrStatus.classList.remove('text-green-600', 'text-red-600');
        return;
      }

      try {
        const response = await fetch('https://your-worker.workers.dev/status', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (response.ok) {
          if (data.connected) {
            qrStatus.textContent = 'Conectado ao WhatsApp!';
            qrStatus.classList.add('text-green-600');
            qrStatus.classList.remove('text-red-600');
            qrCode.classList.add('hidden');
            startBtn.disabled = false;
          } else {
            qrStatus.textContent = 'Escaneie o QR code com o WhatsApp:';
            qrStatus.classList.remove('text-green-600', 'text-red-600');
            qrCode.src = data.qrCode;
            qrCode.classList.remove('hidden');
          }
        } else {
          qrStatus.textContent = data.error || 'Token inválido ou erro no servidor.';
          qrStatus.classList.add('text-red-600');
          qrStatus.classList.remove('text-green-600');
          qrCode.classList.add('hidden');
          startBtn.disabled = true;
        }
      } catch (error) {
        qrStatus.textContent = 'Erro ao carregar QR code.';
        qrStatus.classList.add('text-red-600');
        qrStatus.classList.remove('text-green-600');
        qrCode.classList.add('hidden');
        startBtn.disabled = true;
      }
    }

    // Iniciar envio
    async function startSending() {
      const token = tokenInput.value.trim();
      const numbers = numbersInput.value
        .split('\n')
        .map(n => n.trim())
        .filter(n => n);
      const message = messageInput.value.replace('[saudacao]', getGreeting());

      if (!token) {
        alert('Insira um token válido!');
        return;
      }
      if (!numbers.length) {
        alert('Insira pelo menos um número!');
        return;
      }

      startBtn.disabled = true;
      progressSection.classList.remove('hidden');
      progressText.textContent = `Enviando mensagem 1 de ${numbers.length}`;
      countdownText.classList.remove('hidden');

      try {
        const response = await fetch('https://your-worker.workers.dev/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ numbers, message })
        });
        const result = await response.json();

        if (response.ok) {
          reportSection.classList.remove('hidden');
          reportTotal.textContent = `Total de números: ${result.total}`;
          reportSuccess.textContent = `Sucessos: ${result.success}`;
          reportFailures.textContent = `Falhas: ${result.failures}`;
          reportDuration.textContent = `Tempo total: ${Math.floor(result.duration / 60)}m ${result.duration % 60}s`;

          progressText.textContent = 'Envio concluído!';
          countdownText.classList.add('hidden');
          progressFill.style.width = '100%';
        } else {
          progressText.textContent = result.error || 'Token inválido ou erro no servidor.';
          progressText.classList.add('text-red-600');
          countdownText.classList.add('hidden');
        }
      } catch (error) {
        progressText.textContent = 'Erro durante o envio.';
        progressText.classList.add('text-red-600');
        countdownText.classList.add('hidden');
      } finally {
        startBtn.disabled = false;
      }
    }

    // Atualizar progresso (simulado no frontend)
    function updateProgress(current, total, countdown) {
      progressText.textContent = `Enviando mensagem ${current} de ${total}`;
      progressFill.style.width = `${(current / total) * 100}%`;
      if (countdown > 0) {
        const minutes = Math.floor(countdown / 60);
        const seconds = countdown % 60;
        countdownText.textContent = `Tempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      } else {
        countdownText.classList.add('hidden');
      }
    }

    // Inicializar
    tokenInput.addEventListener('input', checkStatus);
    startBtn.addEventListener('click', startSending);
    setInterval(checkStatus, 10000);
  </script>
</body>
</html>
